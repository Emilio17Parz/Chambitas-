<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rese√±as | CHAMBITAS.COM</title>
  <link rel="stylesheet" href="../assets/css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
      .star-rating { color: #f1c40f; font-size: 1.2rem; }
      
      .pending-card {
          border-left: 5px solid #e37c2a;
          background: #fff;
          padding: 15px;
          margin-bottom: 10px;
          border-radius: 4px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }

      .modal-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
      }
      .modal-content {
          background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px;
      }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
      .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  </style>
</head>
<body>

<header class="site-header">
  <div class="container">
    <div class="brand">
      <a href="../index.html"><img src="../assets/img/chambitas_masc.png" class="logo-masc"></a>
      <a href="../index.html">CHAMBITAS<span>.COM</span></a>
    </div>
    <nav class="main-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="providers.html">Trabajadores</a>
        <a href="calendar.html">Calendario</a>
        <a href="reviews.html" class="active">Rese√±as</a>
        <a href="../profile.html">Mi Perfil</a>
        <button class="btn btn-sm" onclick="forzarCierre()">Cerrar Sesi√≥n</button>
    </nav>
    <button class="menu-toggle">‚ò∞</button>
  </div>
</header>

<main class="page">
<section class="container grid cols-2">
  
  <div>
    <h2>‚≠ê Mi Reputaci√≥n</h2>
    <p>Lo que los trabajadores opinan de ti.</p>
    <div id="myReviewsList" style="margin-top: 20px;">
        <p>Cargando rese√±as...</p>
    </div>
  </div>

  <div>
    <h2>‚úçÔ∏è Calificar Trabajadores</h2>
    <p>Trabajos <strong>finalizados</strong> que a√∫n no has calificado.</p>
    <div id="pendingReviewsList" style="margin-top: 20px;">
        <p>Buscando servicios finalizados...</p>
    </div>
  </div>

</section>
</main>

<div id="reviewModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Calificar a <span id="modalTargetName">Trabajador</span></h3>
        <form id="reviewForm">
            <input type="hidden" id="modalCitaId">
            <input type="hidden" id="modalTargetId">

            <div class="form-group">
                <label>Calificaci√≥n</label>
                <select id="modalRating">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Muy bueno</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê Regular</option>
                    <option value="2">‚≠ê‚≠ê Malo</option>
                    <option value="1">‚≠ê P√©simo</option>
                </select>
            </div>

            <div class="form-group">
                <label>Comentario</label>
                <textarea id="modalComment" rows="4" placeholder="¬øQu√© tal qued√≥ el trabajo?" required></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-muted" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Publicar Rese√±a</button>
            </div>
        </form>
    </div>
</div>

<footer class="site-footer">
  <div class="container footer-grid">
    <div><h4>CHAMBITAS.COM</h4><p>Encuentra al profesional ideal.</p></div>
  </div>
</footer>

<script src="../assets/js/app.js"></script>
<script src="../assets/js/auth-guard.js?v=999"></script>

<script>
const API_URL = "http://localhost:4000";

document.addEventListener("DOMContentLoaded", () => {
    cargarMisResenas();
    cargarPendientes();
});

// FUNCI√ìN DE CIERRE DE SESI√ìN (Global para que el bot√≥n la encuentre)
function forzarCierre() {
    console.log("Cerrando sesi√≥n...");
    localStorage.clear();
    window.location.href = window.location.origin + "/login.html";
}

// 1. CARGAR RESE√ëAS RECIBIDAS
async function cargarMisResenas() {
    const token = localStorage.getItem("token"); 
    const container = document.getElementById("myReviewsList");
    
    if (!token) return; 

    try {
        const res = await fetch(`${API_URL}/api/resenas/mis-resenas`, {
            headers: { "Authorization": "Bearer " + token }
        });
        const reviews = await res.json();
        
        container.innerHTML = "";
        if(reviews.length === 0) {
            container.innerHTML = "<p>A√∫n no tienes rese√±as de trabajadores.</p>";
            return;
        }

        reviews.forEach(r => {
            const stars = "‚≠ê".repeat(r.calificacion);
            const card = document.createElement("div");
            card.className = "card";
            card.style.marginBottom = "10px";
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>üë∑ ${r.nombre} ${r.apellidos || ''}</strong>
                    <span class="star-rating">${stars}</span>
                </div>
                <p style="font-style: italic; color: #555; margin-top: 5px;">"${r.comentario}"</p>
                <small style="color: #999;">${new Date(r.fecha).toLocaleDateString()}</small>
            `;
            container.appendChild(card);
        });

    } catch (error) {
        console.error(error);
        container.innerHTML = "<p>Error al cargar reputaci√≥n.</p>";
    }
}

// 2. CARGAR PENDIENTES
async function cargarPendientes() {
    const token = localStorage.getItem("token");
    const container = document.getElementById("pendingReviewsList");

    try {
        const res = await fetch(`${API_URL}/api/resenas/pendientes`, {
            headers: { "Authorization": "Bearer " + token }
        });
        const pendientes = await res.json();
        
        container.innerHTML = "";
        if(pendientes.length === 0) {
            container.innerHTML = "<p>Est√°s al d√≠a. (Solo puedes calificar citas marcadas como 'COMPLETADA' por el trabajador).</p>";
            return;
        }

        pendientes.forEach(p => {
            const card = document.createElement("div");
            card.className = "pending-card";
            card.innerHTML = `
                <h4>üë∑ ${p.nombre} ${p.apellidos || ''}</h4>
                <p style="font-size: 0.9rem; margin-bottom: 5px;">üìÖ ${new Date(p.fecha).toLocaleDateString()}</p>
                <p style="font-size: 0.9rem;">üõ†Ô∏è Servicio: ${p.motivo}</p>
                <button class="btn btn-sm btn-primary" style="margin-top:10px; width:100%;" 
                    onclick="abrirModal(${p.cita_id}, ${p.otro_usuario_id}, '${p.nombre}')">
                    Calificar Trabajador
                </button>
            `;
            container.appendChild(card);
        });

    } catch (error) {
        console.error(error);
        container.innerHTML = "<p>Error al cargar pendientes.</p>";
    }
}

// 3. MANEJO DEL MODAL
function abrirModal(citaId, targetId, targetName) {
    document.getElementById("modalCitaId").value = citaId;
    document.getElementById("modalTargetId").value = targetId;
    document.getElementById("modalTargetName").textContent = targetName;
    document.getElementById("reviewModal").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("reviewModal").style.display = "none";
}

// 4. ENVIAR RESE√ëA
document.getElementById("reviewForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");
    
    const data = {
        cita_id: document.getElementById("modalCitaId").value,
        destinatario_id: document.getElementById("modalTargetId").value,
        calificacion: document.getElementById("modalRating").value,
        comentario: document.getElementById("modalComment").value
    };

    try {
        const res = await fetch(`${API_URL}/api/resenas/crear`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token 
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            Swal.fire({
                title: '¬°Rese√±a enviada!',
                text: 'Gracias por calificar el trabajo.',
                icon: 'success',
                confirmButtonColor: '#e37c2a'
            });
            cerrarModal();
            cargarPendientes(); 
        } else {
            const err = await res.json();
            Swal.fire('Error', err.error || 'No se pudo enviar.', 'error');
        }
    } catch (error) {
        console.error(error);
        Swal.fire('Error', 'Fallo de conexi√≥n.', 'error');
    }
});
</script>

</body>
</html>