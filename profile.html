<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil | CHAMBITAS.COM</title>
  <link rel="stylesheet" href="assets/css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
      .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
      .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
      .section-box { background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #e37c2a; }
      
      .profile-avatar-container {
          width: 100px; height: 100px; background: #eee; border-radius: 50%; 
          margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; 
          font-size: 40px; overflow: hidden; border: 3px solid #e37c2a;
      }
      .profile-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
  </style>
</head>

<body>
<header class="site-header">
  <div class="container">
    <div class="brand">
        <a href="index.html" style="display: flex; align-items: center; text-decoration: none; color: white; gap: 10px;">
            <img src="assets/img/chambitas_masc.png" alt="Logo" style="height: 40px;">
            CHAMBITAS.COM
        </a>
    </div>
    <nav class="main-nav" id="dynamicNav"></nav>
    <button class="menu-toggle">‚ò∞</button>
  </div>
</header>

<main class="page">
  <section class="container">
    <h2 style="margin-bottom: 20px;">Mi Perfil</h2>

    <div class="card profile-card" style="max-width: 800px; margin: 0 auto;">
      <div style="text-align: center;">
          <div class="profile-avatar-container" id="avatarBox">
              <span id="picPlaceholder">üë§</span>
          </div>
          <h3 id="profileName">Cargando...</h3>
          <span id="profileRoleBadge" class="estado" style="background: #e37c2a; color: white; padding: 2px 8px; border-radius: 10px;">---</span>
      </div>
      <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

      <div class="grid cols-1" style="gap: 15px;">
          <p><strong>üìß Correo:</strong> <span id="profileEmail">---</span></p>
          <p><strong id="labelExtra">üìç Datos extra:</strong> <span id="profileExtra">---</span></p>
      </div>

      <div id="workerSection" style="display: none;">
          <div class="section-box">
              <h4>üìù Descripci√≥n</h4>
              <p id="profileDesc" style="color: #555;">Sin descripci√≥n.</p>
          </div>
          <div class="section-box">
              <h4>üí∞ Mis Tarifas</h4>
              <p id="profileRates" style="color: #555; font-weight: bold;">No especificadas.</p>
          </div>
          
          <div style="margin-top: 30px;">
              <hr style="border:0; border-top:1px solid #eee;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h3>üì∏ Mis Trabajos (Evidencias)</h3>
                  <button class="btn btn-sm" onclick="abrirModalFoto()">+ Subir Foto</button>
              </div>
              <div id="galleryGrid" class="grid cols-3" style="gap: 10px; margin-top: 15px;">
                  <p>Cargando fotos...</p>
              </div>
          </div>
      </div>

      <div style="margin-top: 30px; text-align: center;">
          <button class="btn btn-primary" onclick="abrirModal()">Editar Perfil</button>
      </div>
    </div>
  </section>
</main>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Editar Perfil</h3>
        <form id="editForm">
            <div class="form-group">
                <label>üì∏ Cambiar Foto de Perfil</label>
                <input type="file" id="editFotoPerfil" accept="image/*">
            </div>

            <div class="grid cols-2">
                <div class="form-group"><label>Nombre</label><input id="editNombre" required></div>
                <div class="form-group"><label>Apellidos</label><input id="editApellidos" required></div>
            </div>
            <div class="form-group"><label>Domicilio</label><input id="editDomicilio"></div>
            
            <div class="form-group" id="divEditOficio"><label>Oficio</label><input id="editOficio"></div>

            <div id="workerInputs" style="display:none;">
                <div class="form-group">
                    <label>Descripci√≥n corta</label>
                    <input id="editDesc" placeholder="Ej: Experto en instalaciones...">
                </div>
                <div class="form-group">
                    <label>üí∞ Mis Tarifas</label>
                    <input id="editRates" placeholder="Ej: $200 visita">
                </div>
            </div>

            <div style="display:flex; justify-content: flex-end; gap:10px;">
                <button type="button" class="btn btn-muted" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script src="assets/js/app.js"></script>
<script>
    const API_URL = "https://chambitas-backend-ncie.onrender.com";
    let currentUserData = {};

    // Funci√≥n para corregir visualmente la √ë y acentos rotos
    function corregirOrtografia() {
        const elementos = document.querySelectorAll('body *:not(script):not(style)');
        elementos.forEach(el => {
            if (el.children.length === 0 && el.textContent !== "") {
                el.textContent = el.textContent
                    .replace(/\?\?/g, '√±') 
                    .replace(/M\?xico/g, 'M√©xico'); 
            }
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("userRole");
        const navContainer = document.getElementById("dynamicNav");
        
        if (!token) { window.location.href = "login.html"; return; }

        // MEN√ö COMPLETO SEG√öN EL ROL
        let menuHTML = '';
        if (role === 'trabajador') {
            menuHTML = `
                <a href="trabajadores/dashboard.html">Dashboard</a>
                <a href="trabajadores/calendar.html">Calendario</a>
                <a href="profile.html" class="active">Mi Perfil</a>`;
        } else {
            menuHTML = `
                <a href="clientes/dashboard.html">Dashboard</a>
                <a href="clientes/providers.html">Trabajadores</a>
                <a href="clientes/calendar.html">Calendario</a>
                <a href="clientes/reviews.html">Rese√±as</a>
                <a href="profile.html" class="active">Mi Perfil</a>`;
        }
        menuHTML += `<button class="btn btn-sm" onclick="logout()" style="margin-left: 10px;">Cerrar Sesi√≥n</button>`;
        navContainer.innerHTML = menuHTML;

        try {
            const res = await fetch(`${API_URL}/api/users/profile`, { headers: { "Authorization": "Bearer " + token } });
            if (res.ok) {
                const user = await res.json();
                currentUserData = user;
                mostrarDatos(user);
                corregirOrtografia(); // Corrige la √ë al terminar de cargar
            }
        } catch (error) { console.error(error); }

        document.getElementById("editForm").addEventListener("submit", e => { e.preventDefault(); guardarPerfil(); });
    });

    function mostrarDatos(user) {
        document.getElementById("profileName").textContent = `${user.nombre} ${user.apellidos || ''}`;
        document.getElementById("profileEmail").textContent = user.correo;
        document.getElementById("profileRoleBadge").textContent = user.tipo_usuario.toUpperCase();
        
        if (user.foto_perfil) {
            const avatarBox = document.getElementById("avatarBox");
            avatarBox.innerHTML = `<img src="${API_URL}/uploads/perfiles/${user.foto_perfil}" alt="Perfil">`;
        }

        const labelExtra = document.getElementById("labelExtra");
        const valExtra = document.getElementById("profileExtra");

        if (user.tipo_usuario === 'trabajador') {
            labelExtra.textContent = "üõ†Ô∏è Oficio:";
            valExtra.textContent = user.oficio || "No especificado";
            document.getElementById("workerSection").style.display = "block";
            document.getElementById("profileDesc").textContent = user.descripcion || "Sin descripci√≥n.";
            document.getElementById("profileRates").textContent = user.tarifas || "Preguntar.";
            cargarGaleria(user.id);
        } else {
            labelExtra.textContent = "üè† Domicilio:";
            valExtra.textContent = user.domicilio || "No especificado";
            document.getElementById("workerSection").style.display = "none";
        }
    }

    async function guardarPerfil() {
        const token = localStorage.getItem("token");
        const formData = new FormData();
        
        formData.append("nombre", document.getElementById("editNombre").value);
        formData.append("apellidos", document.getElementById("editApellidos").value);
        formData.append("domicilio", document.getElementById("editDomicilio").value);
        formData.append("oficio", document.getElementById("editOficio").value);
        formData.append("descripcion", document.getElementById("editDesc").value);
        formData.append("tarifas", document.getElementById("editRates").value);
        
        const fotoInput = document.getElementById("editFotoPerfil");
        if (fotoInput.files.length > 0) {
            formData.append("foto_perfil", fotoInput.files[0]);
        }

        try {
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });
            const res = await fetch(`${API_URL}/api/users/profile`, {
                method: "PUT",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            });
            if (res.ok) {
                Swal.fire("√âxito", "Perfil actualizado", "success").then(() => window.location.reload());
            } else Swal.fire("Error", "No se pudo actualizar", "error");
        } catch (e) { Swal.fire("Error", "Fallo de conexi√≥n", "error"); }
    }

    function abrirModal() {
        const user = currentUserData;
        document.getElementById("editModal").style.display = "flex";
        document.getElementById("editNombre").value = user.nombre;
        document.getElementById("editApellidos").value = user.apellidos || "";
        document.getElementById("editDomicilio").value = user.domicilio || "";
        
        if (user.tipo_usuario === 'trabajador') {
            document.getElementById("divEditOficio").style.display = "block";
            document.getElementById("workerInputs").style.display = "block";
            document.getElementById("editOficio").value = user.oficio || "";
            document.getElementById("editDesc").value = user.descripcion || "";
            document.getElementById("editRates").value = user.tarifas || "";
        } else {
            document.getElementById("divEditOficio").style.display = "none";
            document.getElementById("workerInputs").style.display = "none";
        }
        corregirOrtografia();
    }

    function logout() { localStorage.clear(); window.location.href = "login.html"; }
    function cerrarModal() { document.getElementById("editModal").style.display = "none"; }

    async function cargarGaleria(userId) {
        try {
            const res = await fetch(`${API_URL}/api/users/evidencia/${userId}`);
            const fotos = await res.json();
            const grid = document.getElementById("galleryGrid");
            grid.innerHTML = (fotos.length === 0) ? "<p>No hay fotos a√∫n.</p>" : "";
            fotos.forEach(f => {
                grid.innerHTML += `
                    <div style="border:1px solid #ddd; border-radius:4px; overflow:hidden; background:white;">
                        <img src="${API_URL}/uploads/trabajos/${f.ruta_foto}" style="width:100%; height:150px; object-fit:cover;">
                        <p style="padding:5px; font-size:0.8rem; margin:0; text-align:center;">${f.descripcion || 'Evidencia'}</p>
                    </div>`;
            });
            corregirOrtografia();
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>